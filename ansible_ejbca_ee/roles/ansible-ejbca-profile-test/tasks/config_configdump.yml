---

- name: Check if Configdump already exists
  stat:
    path: "{{ ejbca_home }}/dist/configdump/configdump.jar"
  register: cfgdump_exists

- name: Build Configdump
  command: "/usr/bin/ant -q configdump"
  args:
    chdir: "{{ ejbca_home }}"
    creates: "{{ ejbca_home }}/dist/configdump/configdump.jar"
  become_user: "{{ ejbca_user }}"
  become_method: sudo
  when: not cfgdump_exists.stat.exists

- name: Create confifdump file structure for all the imports
  file:
    path: "{{ item }}"
    state: directory
    mode: 0750
    owner: "{{ ejbca_user }}"
    group: "{{ ejbca_group }}"
  loop: "{{ configdump_directory_structure }}"

- name: Prepare configdump certificate profiles template files for importing
  template:
    src: cp-template.yaml.j2
    dest: "{{ ejbca_home }}/dump/dump4/certficiate-profiles/{{ item.cpname }}"
    owner: "{{ ejbca_user }}"
    group: "{{ ejbca_group }}"
    mode: 0664
  loop: "{{ certificate_profiles }}"
  loop_control:
    label: "{{ item.cpname }}"

- name: Prepare configdump certificate profiles template files for importing
  template:
    src: cp-template.yaml.j2
    dest: "{{ ejbca_home }}/dump/dump4/certficiate-profiles/{{ item.cpname }}"
    owner: "{{ ejbca_user }}"
    group: "{{ ejbca_group }}"
    mode: 0664
  loop: "{{ end_entity_profiles }}"
  loop_control:
    label: "{{ item.cpname }}"
